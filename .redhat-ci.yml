branches:
    - master
    - auto
    - try

container:
    image: projectatomic/ostree-tester

packages:
  - git
  - clang
  - libubsan
  - python-sphinx
  - createrepo_c
  - gperf
  - rpm-build
  - bubblewrap
  - python-devel
  - check-devel
  - pkgconfig(ostree-1)
  - pkgconfig(libgsystem)
  - pkgconfig(libcap)
  - pkgconfig(librepo)
  - pkgconfig(libsolv)
  - pkgconfig(libsystemd)
  - pkgconfig(libarchive)
  - pkgconfig(rpm)
  - pkgconfig(json-glib-1.0)
  - pkgconfig(expat)
  - cmake
  - gtk-doc

tests:
    - ./autogen.sh
        --prefix=/usr
        --libdir=/usr/lib64
        --enable-installed-tests
        --enable-gtk-doc
        CFLAGS='-fsanitize=undefined'
    - make -j2
    - make check
    - make install
    - gnome-desktop-testing-runner rpm-ostree
    - sudo --user=testuser gnome-desktop-testing-runner rpm-ostree

timeout: 30m

artifacts:
    - test-suite.log

---

inherit: true

tests:
    - ./autogen.sh
        --prefix=/usr
        --libdir=/usr/lib64
        --enable-installed-tests
        --enable-gtk-doc CC=clang
    - make -j2

context: Clang

artifacts:

---

inherit: true

host:
  distro: fedora/24/cloud

context: rhci/vmcheck

env:
  VAGRANT_DEFAULT_PROVIDER: libvirt
  VAGRANT_BOX_URL: https://ci.centos.org/artifacts/sig-atomic/centos-continuous/images/cloud/latest/images/centos-atomic-host-7-vagrant-libvirt.box
  VAGRANT_BOX: centos/7/atomic/continuous

# We'll need to add some sugar to redhat-ci to make this
# nicer. E.g. allow provision multiple hosts, or a host and
# a container.

tests:
  - dnf install -y vagrant libvirt qemu-kvm vagrant-libvirt ansible libselinux-python
  - systemctl start libvirtd virtlogd
  - vagrant box add --name $VAGRANT_BOX $VAGRANT_BOX_URL
  - vagrant up
  - sh autogen.sh
  - make gitignore # needed to have a clean rsync
  - make vmcheck

artifacts:
  - vmcheck.log

timeout: 45m
